<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription Plans - School Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .plan-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 2px solid #e9ecef;
        }
        .plan-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .plan-card.selected {
            border-color: #007bff;
            background-color: #f8f9ff;
        }
        .plan-card.featured {
            border-color: #28a745;
            position: relative;
        }
        .plan-card.featured::before {
            content: "Most Popular";
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: #28a745;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        .payment-method {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .payment-method:hover {
            border-color: #007bff;
            background-color: #f8f9ff;
        }
        .payment-method.selected {
            border-color: #007bff;
            background-color: #e3f2fd;
        }
        .payment-method input[type="radio"] {
            margin-right: 10px;
        }
        .upi-icon {
            width: 30px;
            height: 30px;
            margin-right: 10px;
        }
        .loading {
            display: none;
        }
        .success-message {
            display: none;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .error-message {
            display: none;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .feature-list {
            list-style: none;
            padding: 0;
        }
        .feature-list li {
            padding: 5px 0;
            display: flex;
            align-items: center;
        }
        .feature-list li i {
            color: #28a745;
            margin-right: 10px;
        }
        .price-display {
            font-size: 2.5rem;
            font-weight: bold;
            color: #007bff;
        }
        .currency {
            font-size: 1.2rem;
            vertical-align: top;
        }
        .billing-cycle {
            font-size: 0.9rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="#">
                    <i class="fas fa-graduation-cap me-2"></i>
                    School Management System
                </a>
                <div class="navbar-nav ms-auto">
                    <span class="navbar-text">
                        <i class="fas fa-user me-1"></i>
                        <span th:text="${#authentication.name}">User</span>
                    </span>
                </div>
            </div>
        </nav>

        <div class="container mt-4">
            <!-- Success/Error Messages -->
            <div id="successMessage" class="success-message">
                <i class="fas fa-check-circle me-2"></i>
                <span id="successText">Payment successful! Your subscription is now active.</span>
            </div>
            
            <div id="errorMessage" class="error-message">
                <i class="fas fa-exclamation-circle me-2"></i>
                <span id="errorText">Payment failed. Please try again.</span>
            </div>

            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="text-center mb-3">
                        <i class="fas fa-crown text-warning me-2"></i>
                        Choose Your Subscription Plan
                    </h1>
                    <p class="text-center text-muted">
                        Unlock the full potential of your school management system
                    </p>
                </div>
            </div>

            <!-- Subscription Plans -->
            <div class="row mb-5">
                <div class="col-12">
                    <h3 class="mb-4">Available Plans</h3>
                </div>
                
                <!-- Basic Plan -->
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card plan-card h-100" data-plan="BASIC" data-amount="2999">
                        <div class="card-body text-center">
                            <h5 class="card-title">Basic Plan</h5>
                            <div class="price-display">
                                <span class="currency">₹</span>2,999
                            </div>
                            <div class="billing-cycle">per month</div>
                            <p class="card-text text-muted">Perfect for small schools</p>
                            
                            <ul class="feature-list">
                                <li><i class="fas fa-check"></i> Up to 100 students</li>
                                <li><i class="fas fa-check"></i> Up to 10 teachers</li>
                                <li><i class="fas fa-check"></i> Basic features</li>
                                <li><i class="fas fa-times text-danger"></i> AI Chatbot</li>
                                <li><i class="fas fa-times text-danger"></i> SMS Integration</li>
                            </ul>
                            
                            <button class="btn btn-outline-primary w-100" onclick="selectPlan('BASIC', 2999)">
                                Select Plan
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Professional Plan -->
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card plan-card h-100 featured" data-plan="PROFESSIONAL" data-amount="8999">
                        <div class="card-body text-center">
                            <h5 class="card-title">Professional Plan</h5>
                            <div class="price-display">
                                <span class="currency">₹</span>8,999
                            </div>
                            <div class="billing-cycle">per month</div>
                            <p class="card-text text-muted">Most popular choice</p>
                            
                            <ul class="feature-list">
                                <li><i class="fas fa-check"></i> Up to 500 students</li>
                                <li><i class="fas fa-check"></i> Up to 25 teachers</li>
                                <li><i class="fas fa-check"></i> AI Chatbot (50 queries/day)</li>
                                <li><i class="fas fa-check"></i> SMS Integration</li>
                                <li><i class="fas fa-check"></i> Advanced Analytics</li>
                                <li><i class="fas fa-check"></i> Custom Fields</li>
                            </ul>
                            
                            <button class="btn btn-success w-100" onclick="selectPlan('PROFESSIONAL', 8999)">
                                Select Plan
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Premium Plan -->
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card plan-card h-100" data-plan="PREMIUM" data-amount="19999">
                        <div class="card-body text-center">
                            <h5 class="card-title">Premium Plan</h5>
                            <div class="price-display">
                                <span class="currency">₹</span>19,999
                            </div>
                            <div class="billing-cycle">per month</div>
                            <p class="card-text text-muted">For growing schools</p>
                            
                            <ul class="feature-list">
                                <li><i class="fas fa-check"></i> Up to 1,500 students</li>
                                <li><i class="fas fa-check"></i> Up to 50 teachers</li>
                                <li><i class="fas fa-check"></i> AI Chatbot (200 queries/day)</li>
                                <li><i class="fas fa-check"></i> SMS & WhatsApp Integration</li>
                                <li><i class="fas fa-check"></i> Advanced Analytics</li>
                                <li><i class="fas fa-check"></i> Transport & Hostel Management</li>
                            </ul>
                            
                            <button class="btn btn-outline-primary w-100" onclick="selectPlan('PREMIUM', 19999)">
                                Select Plan
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Enterprise Plan -->
                <div class="col-lg-3 col-md-6 mb-4">
                    <div class="card plan-card h-100" data-plan="ENTERPRISE" data-amount="49999">
                        <div class="card-body text-center">
                            <h5 class="card-title">Enterprise Plan</h5>
                            <div class="price-display">
                                <span class="currency">₹</span>49,999
                            </div>
                            <div class="billing-cycle">per month</div>
                            <p class="card-text text-muted">For large institutions</p>
                            
                            <ul class="feature-list">
                                <li><i class="fas fa-check"></i> Unlimited students</li>
                                <li><i class="fas fa-check"></i> Unlimited teachers</li>
                                <li><i class="fas fa-check"></i> AI Chatbot (unlimited)</li>
                                <li><i class="fas fa-check"></i> All integrations</li>
                                <li><i class="fas fa-check"></i> Priority support</li>
                                <li><i class="fas fa-check"></i> Custom development</li>
                            </ul>
                            
                            <button class="btn btn-outline-primary w-100" onclick="selectPlan('ENTERPRISE', 49999)">
                                Select Plan
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Payment Method Selection -->
            <div class="row mb-4" id="paymentSection" style="display: none;">
                <div class="col-12">
                    <h3 class="mb-4">Choose Payment Method</h3>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="payment-method" onclick="selectPaymentMethod('UPI')">
                                <input type="radio" name="paymentMethod" value="UPI" id="upi">
                                <label for="upi" class="d-flex align-items-center">
                                    <img src="https://via.placeholder.com/30x30/007bff/ffffff?text=UPI" alt="UPI" class="upi-icon">
                                    <div>
                                        <strong>UPI</strong><br>
                                        <small class="text-muted">Google Pay, PhonePe, Paytm</small>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <div class="payment-method" onclick="selectPaymentMethod('CREDIT_CARD')">
                                <input type="radio" name="paymentMethod" value="CREDIT_CARD" id="card">
                                <label for="card" class="d-flex align-items-center">
                                    <i class="fas fa-credit-card fa-2x text-primary me-3"></i>
                                    <div>
                                        <strong>Credit Card</strong><br>
                                        <small class="text-muted">Visa, Mastercard, RuPay</small>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <div class="payment-method" onclick="selectPaymentMethod('NET_BANKING')">
                                <input type="radio" name="paymentMethod" value="NET_BANKING" id="netbanking">
                                <label for="netbanking" class="d-flex align-items-center">
                                    <i class="fas fa-university fa-2x text-success me-3"></i>
                                    <div>
                                        <strong>Net Banking</strong><br>
                                        <small class="text-muted">All major banks</small>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- UPI AutoPay Option -->
                    <div class="row mt-3" id="upiAutoPaySection" style="display: none;">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <h5><i class="fas fa-sync-alt text-primary me-2"></i>UPI AutoPay</h5>
                                    <p class="text-muted">Enable automatic monthly payments for seamless subscription renewal</p>
                                    
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="enableAutoPay">
                                        <label class="form-check-label" for="enableAutoPay">
                                            Enable UPI AutoPay for automatic renewal
                                        </label>
                                    </div>
                                    
                                    <div class="mt-3" id="upiIdSection" style="display: none;">
                                        <label for="upiId" class="form-label">UPI ID</label>
                                        <input type="text" class="form-control" id="upiId" placeholder="yourname@paytm">
                                        <small class="form-text text-muted">Enter your UPI ID for automatic payments</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Button -->
                    <div class="text-center mt-4">
                        <button id="payNowBtn" class="btn btn-success btn-lg" onclick="initiatePayment()" disabled>
                            <i class="fas fa-lock me-2"></i>
                            Pay <span id="paymentAmount">₹0</span>
                        </button>
                        
                        <div class="loading mt-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Processing...</span>
                            </div>
                            <p class="mt-2">Processing your payment...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Razorpay Script -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let selectedPlan = null;
        let selectedAmount = 0;
        let selectedPaymentMethod = null;
        let currentSubscriptionId = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Get current subscription ID (this would come from your backend)
            currentSubscriptionId = getCurrentSubscriptionId();
            
            // Check if user already has an active subscription
            checkExistingSubscription();
        });

        function selectPlan(plan, amount) {
            // Remove previous selection
            document.querySelectorAll('.plan-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Select new plan
            const planCard = document.querySelector(`[data-plan="${plan}"]`);
            planCard.classList.add('selected');
            
            selectedPlan = plan;
            selectedAmount = amount;
            
            // Show payment section
            document.getElementById('paymentSection').style.display = 'block';
            
            // Update payment amount
            document.getElementById('paymentAmount').textContent = `₹${amount.toLocaleString()}`;
            
            // Scroll to payment section
            document.getElementById('paymentSection').scrollIntoView({ behavior: 'smooth' });
        }

        function selectPaymentMethod(method) {
            // Remove previous selection
            document.querySelectorAll('.payment-method').forEach(payment => {
                payment.classList.remove('selected');
            });
            
            // Select new method
            const paymentMethod = document.querySelector(`[value="${method}"]`).closest('.payment-method');
            paymentMethod.classList.add('selected');
            
            selectedPaymentMethod = method;
            
            // Show UPI AutoPay section for UPI payments
            if (method === 'UPI') {
                document.getElementById('upiAutoPaySection').style.display = 'block';
            } else {
                document.getElementById('upiAutoPaySection').style.display = 'none';
            }
            
            // Enable pay button
            document.getElementById('payNowBtn').disabled = false;
        }

        // Handle UPI AutoPay checkbox
        document.getElementById('enableAutoPay').addEventListener('change', function() {
            const upiIdSection = document.getElementById('upiIdSection');
            if (this.checked) {
                upiIdSection.style.display = 'block';
            } else {
                upiIdSection.style.display = 'none';
            }
        });

        function initiatePayment() {
            if (!selectedPlan || !selectedPaymentMethod) {
                showError('Please select a plan and payment method');
                return;
            }

            // Show loading
            document.querySelector('.loading').style.display = 'block';
            document.getElementById('payNowBtn').disabled = true;

            // Prepare payment order request
            const orderRequest = {
                subscriptionId: currentSubscriptionId || generateSubscriptionId(),
                plan: selectedPlan,
                amount: selectedAmount,
                planName: `${selectedPlan} Plan`,
                schoolName: getCurrentSchoolName(),
                paymentMethod: selectedPaymentMethod,
                billingCycle: 1,
                autoRenew: document.getElementById('enableAutoPay').checked,
                upiId: document.getElementById('upiId').value || null,
                upiAutoPayEnabled: document.getElementById('enableAutoPay').checked,
                customerName: getCurrentUserName(),
                customerEmail: getCurrentUserEmail(),
                customerPhone: getCurrentUserPhone(),
                notes: `Subscription payment for ${selectedPlan} plan`
            };

            // Create payment order
            fetch('/api/v1/payments/create-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + getAuthToken()
                },
                body: JSON.stringify(orderRequest)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success !== false) {
                    // Open Razorpay checkout
                    openRazorpayCheckout(data);
                } else {
                    throw new Error(data.message || 'Failed to create payment order');
                }
            })
            .catch(error => {
                console.error('Payment initiation failed:', error);
                showError('Payment initiation failed. Please try again.');
                hideLoading();
            });
        }

        function openRazorpayCheckout(orderData) {
            const options = {
                key: orderData.keyId,
                amount: orderData.amount,
                currency: orderData.currency,
                name: 'School Management System',
                description: `Subscription Payment - ${orderData.planName}`,
                order_id: orderData.orderId,
                handler: function (response) {
                    // Verify payment
                    verifyPayment(response, orderData.subscriptionId);
                },
                prefill: {
                    name: getCurrentUserName(),
                    email: getCurrentUserEmail(),
                    contact: getCurrentUserPhone()
                },
                theme: {
                    color: '#007bff'
                },
                method: {
                    upi: selectedPaymentMethod === 'UPI',
                    card: selectedPaymentMethod === 'CREDIT_CARD',
                    netbanking: selectedPaymentMethod === 'NET_BANKING'
                },
                modal: {
                    ondismiss: function() {
                        hideLoading();
                    }
                }
            };

            const rzp = new Razorpay(options);
            rzp.open();
        }

        function verifyPayment(response, subscriptionId) {
            const verificationRequest = {
                orderId: response.razorpay_order_id,
                paymentId: response.razorpay_payment_id,
                signature: response.razorpay_signature,
                subscriptionId: subscriptionId,
                paymentMethod: selectedPaymentMethod,
                transactionId: response.razorpay_payment_id,
                remarks: `Payment successful for ${selectedPlan} plan`
            };

            fetch('/api/v1/payments/verify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + getAuthToken()
                },
                body: JSON.stringify(verificationRequest)
            })
            .then(response => response.json())
            .then(data => {
                hideLoading();
                
                if (data.success) {
                    showSuccess(`Payment successful! Your ${data.planName} subscription is now active.`);
                    
                    // Redirect to dashboard after 3 seconds
                    setTimeout(() => {
                        window.location.href = '/dashboard';
                    }, 3000);
                } else {
                    showError(data.message || 'Payment verification failed');
                }
            })
            .catch(error => {
                console.error('Payment verification failed:', error);
                hideLoading();
                showError('Payment verification failed. Please contact support.');
            });
        }

        function showSuccess(message) {
            document.getElementById('successText').textContent = message;
            document.getElementById('successMessage').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
        }

        function hideLoading() {
            document.querySelector('.loading').style.display = 'none';
            document.getElementById('payNowBtn').disabled = false;
        }

        // Helper functions (these would be implemented based on your authentication system)
        function getAuthToken() {
            return localStorage.getItem('token') || sessionStorage.getItem('token');
        }

        function getCurrentUserName() {
            return 'School Admin'; // This should come from your user session
        }

        function getCurrentUserEmail() {
            return 'admin@school.com'; // This should come from your user session
        }

        function getCurrentUserPhone() {
            return '9876543210'; // This should come from your user session
        }

        function getCurrentSchoolName() {
            return 'ABC School'; // This should come from your school data
        }

        function getCurrentSubscriptionId() {
            // This should come from your backend or be generated
            return null;
        }

        function generateSubscriptionId() {
            return Date.now(); // Simple ID generation
        }

        function checkExistingSubscription() {
            // Check if user already has an active subscription
            fetch('/api/v1/payments/subscriptions/active', {
                headers: {
                    'Authorization': 'Bearer ' + getAuthToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success !== false && data.data) {
                    showSuccess(`You already have an active ${data.data.planName} subscription.`);
                    document.getElementById('paymentSection').style.display = 'none';
                }
            })
            .catch(error => {
                console.log('No active subscription found');
            });
        }
    </script>
</body>
</html>
