<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin Dashboard - School Management System</title>

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            200: '#bfdbfe',
                            300: '#93c5fd',
                            400: '#60a5fa',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            800: '#1e40af',
                            900: '#1e3a8a',
                        }
                    }
                }
            }
        }
    </script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .sidebar-transition {
            transition: all 0.3s ease;
        }
        .sidebar-mobile {
            transform: translateX(-100%);
        }
        .sidebar-mobile.open {
            transform: translateX(0);
        }
        
        /* CRITICAL FIX: Force roles table to always be visible when section is shown */
        #rolesSection:not(.hidden) {
            display: block !important;
            min-height: 400px;
        }
        
        /* CRITICAL: Force roles table visibility - override ALL CSS */
        #rolesSection:not(.hidden) #rolesTable {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            height: auto !important;
            width: 100% !important;
            background: white !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 0.375rem !important;
            overflow: visible !important;
        }
        
        /* Force table content to be visible */
        #rolesSection:not(.hidden) #rolesTable table {
            display: table !important;
            width: 100% !important;
            border-collapse: collapse !important;
        }
        
        #rolesSection:not(.hidden) #rolesTable thead {
            display: table-header-group !important;
        }
        
        #rolesSection:not(.hidden) #rolesTable tbody {
            display: table-row-group !important;
        }
        
        #rolesSection:not(.hidden) #rolesTable tr {
            display: table-row !important;
        }
        
        #rolesSection:not(.hidden) #rolesTable td, 
        #rolesSection:not(.hidden) #rolesTable th {
            display: table-cell !important;
        }
        
        @media (min-width: 768px) {
            .sidebar-mobile {
                transform: translateX(0);
            }
        }
        .nav-item.active {
            background-color: #eff6ff;
            color: #2563eb;
        }
        .nav-item.active i {
            color: #2563eb;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Mobile Overlay -->
    <div class="fixed inset-0 z-40 bg-black bg-opacity-50 hidden" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Sidebar -->
    <div class="fixed inset-y-0 left-0 z-50 w-64 bg-white shadow-lg sidebar-transition sidebar-mobile" id="sidebar">
        <!-- Logo -->
        <div class="flex items-center justify-between h-16 bg-primary-600 px-4">
            <div class="flex items-center space-x-2">
                <i class="fas fa-user-shield text-white text-2xl"></i>
                <span class="text-xl font-bold text-white">Super Admin</span>
            </div>
            <!-- Mobile Close Button -->
            <button onclick="toggleSidebar()" class="md:hidden p-2 rounded-md text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary-300">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>

        <!-- User Info -->
        <div class="p-4 border-b border-gray-200">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-user-shield text-primary-600"></i>
                </div>
                <div>
                    <p class="text-sm font-medium text-gray-900" id="userName">Super Admin</p>
                    <p class="text-xs text-gray-500">System Administrator</p>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="mt-5 px-2">
            <div class="space-y-1">
                <a href="#" onclick="showSection('overview'); return false;" data-section="overview" class="nav-item active group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                    <i class="fas fa-chart-line text-gray-400 mr-3"></i>
                    Overview
                </a>
                <a href="#" onclick="showSection('users'); return false;" data-section="users" class="nav-item text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                    <i class="fas fa-users text-gray-400 mr-3"></i>
                    User Management
                </a>
                <a href="#" onclick="showSection('roles'); return false;" data-section="roles" class="nav-item text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                    <i class="fas fa-user-shield text-gray-400 mr-3"></i>
                    Role Management
                </a>
                <div class="pt-4 mt-4 border-t border-gray-200">
                    <a href="#" class="nav-item text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                        <i class="fas fa-school text-gray-400 mr-3"></i>
                        Schools
                    </a>
                    <a href="#" class="nav-item text-gray-600 hover:bg-gray-50 hover:text-gray-900 group flex items-center px-2 py-2 text-sm font-medium rounded-md">
                        <i class="fas fa-cog text-gray-400 mr-3"></i>
                        Settings
                    </a>
                </div>
            </div>
        </nav>

        <!-- Logout Button (at bottom) -->
        <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-200">
            <button onclick="logout()" class="w-full flex items-center px-2 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded-md">
                <i class="fas fa-sign-out-alt mr-3"></i>
                Logout
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="pl-0 md:pl-64" id="mainContent">
        <!-- Top Navigation -->
        <div class="bg-white shadow-sm border-b border-gray-200">
            <div class="px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Mobile Menu Button & Page Title -->
                    <div class="flex items-center space-x-4">
                        <!-- Mobile Menu Button -->
                        <button onclick="toggleSidebar()" class="md:hidden p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-primary-500">
                            <i class="fas fa-bars text-xl"></i>
                        </button>

                        <!-- Page Title -->
                        <div>
                            <h1 class="text-2xl font-semibold text-gray-900" id="pageTitle">Dashboard Overview</h1>
                            <p class="text-sm text-gray-500" id="pageSubtitle">System-wide analytics and management</p>
                        </div>
                    </div>

                    <!-- Top Right Actions -->
                    <div class="flex items-center space-x-4">
                        <!-- Notifications -->
                        <div class="relative">
                            <button class="p-2 text-gray-400 hover:text-gray-500 relative">
                                <i class="fas fa-bell text-xl"></i>
                                <span class="absolute -top-1 -right-1 h-4 w-4 bg-red-500 text-white text-xs rounded-full flex items-center justify-center">5</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Sections -->
        <div class="p-4 sm:p-6 lg:p-8">
            <!-- Overview Section -->
            <div id="overviewSection" class="content-section">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Stats Cards -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-school text-blue-600 text-xl"></i>
                                </div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">Total Schools</p>
                                <p class="text-2xl font-semibold text-gray-900">25</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-users text-green-600 text-xl"></i>
                                </div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">Total Users</p>
                                <p class="text-2xl font-semibold text-gray-900" id="totalUsersCount">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-user-shield text-purple-600 text-xl"></i>
                                </div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">Total Roles</p>
                                <p class="text-2xl font-semibold text-gray-900" id="totalRolesCount">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-chart-line text-yellow-600 text-xl"></i>
                                </div>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">Active Now</p>
                                <p class="text-2xl font-semibold text-gray-900">142</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Quick Actions</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button onclick="showSection('users')" class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                            <i class="fas fa-users text-primary-600 text-2xl mr-3"></i>
                            <div class="text-left">
                                <p class="font-medium text-gray-900">Manage Users</p>
                                <p class="text-sm text-gray-500">View and edit users</p>
                            </div>
                        </button>
                        <button onclick="showSection('roles')" class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                            <i class="fas fa-user-shield text-primary-600 text-2xl mr-3"></i>
                            <div class="text-left">
                                <p class="font-medium text-gray-900">Manage Roles</p>
                                <p class="text-sm text-gray-500">Configure permissions</p>
                            </div>
                        </button>
                        <button class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                            <i class="fas fa-chart-bar text-primary-600 text-2xl mr-3"></i>
                            <div class="text-left">
                                <p class="font-medium text-gray-900">View Reports</p>
                                <p class="text-sm text-gray-500">System analytics</p>
                            </div>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="usersSection" class="content-section hidden">
                <div class="mt-0 bg-white rounded-lg shadow p-6">
                    <div class="mb-6">

                    <!-- Controls -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
                        <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
                            <!-- Search -->
                            <div class="relative flex-1 max-w-md">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-lg">🔍</span>
                                <input
                                        type="text"
                                        id="searchInput"
                                        placeholder="Search by name, email, or username..."
                                        class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                />
                            </div>

                            <div class="flex gap-4 items-center">
                                <!-- Page Size Selector -->
                                <select id="pageSizeSelect" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="3">3 per page</option>
                                    <option value="5">5 per page</option>
                                    <option value="10" selected>10 per page</option>
                                    <option value="15">15 per page</option>
                                    <option value="20">20 per page</option>
                                    <option value="25">25 per page</option>
                                </select>

                                <!-- Stats -->
                                <div class="text-sm text-gray-600 bg-gray-100 px-3 py-2 rounded-lg">
                                    <span class="font-medium text-gray-900" id="totalUsers">0</span> total users
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
                        <div class="border-b border-gray-200">
                            <nav class="flex flex-nowrap gap-4 px-0 sm:px-6 overflow-x-auto scrollbar-thin scrollbar-none" role="tablist">
                        <button role="tab" onclick="handleTabChange(0)" class="flex items-center gap-2 px-3 sm:px-4 py-3 border-b-2 font-medium text-sm transition-colors whitespace-nowrap border-blue-500 text-blue-600" id="tab-0">
                            <span class="text-base sm:text-lg">👥</span>
                            <span>All Users</span>
                        </button>
                        <button role="tab" onclick="handleTabChange(1)" class="flex items-center gap-2 px-3 sm:px-4 py-3 border-b-2 font-medium text-sm transition-colors whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" id="tab-1">
                            <span class="text-base sm:text-lg">✅</span>
                            <span>Active</span>
                        </button>
                        <button role="tab" onclick="handleTabChange(2)" class="flex items-center gap-2 px-3 sm:px-4 py-3 border-b-2 font-medium text-sm transition-colors whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" id="tab-2">
                            <span class="text-base sm:text-lg">❌</span>
                            <span>Deleted</span>
                        </button>
                        <button role="tab" onclick="handleTabChange(3)" class="flex items-center gap-2 px-3 sm:px-4 py-3 border-b-2 font-medium text-sm transition-colors whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" id="tab-3">
                            <span class="text-base sm:text-lg">⏰</span>
                            <span>Expired</span>
                        </button>
                            </nav>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div id="loadingState" class="bg-white rounded-xl shadow-sm border border-gray-200 p-8 hidden">
                        <div class="flex items-center justify-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                            <span class="ml-3 text-gray-600">Loading users...</span>
                        </div>
                    </div>

                    <!-- Error State -->
                    <div id="errorState" class="bg-red-50 border border-red-200 rounded-xl p-4 mb-6 hidden">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <span class="text-red-400 text-lg">⚠️</span>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-red-800" id="errorMessage"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Users Table -->
                    <div id="usersTableContainer" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Roles</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="usersTable">
                                    <!-- Users data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div class="mt-6 flex items-center justify-between">
                        <div class="text-sm text-gray-700">
                            Showing <span id="showingStart">0</span> to <span id="showingEnd">0</span> of <span id="totalUsers">0</span> users
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="changePage('prev')" id="prevBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-chevron-left mr-1"></i>Previous
                            </button>
                            <button onclick="changePage('next')" id="nextBtn" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                Next<i class="fas fa-chevron-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Role Editor Modal -->
                <div id="roleEditorModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 pt-20 z-50 hidden">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md">
                        <!-- Header -->
                        <div class="relative bg-gradient-to-r from-slate-50 to-gray-50 p-6 rounded-t-2xl border-b border-gray-100">
                            <button onclick="closeRoleModal()" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 transition-colors text-gray-500 hover:text-gray-700">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                            <h3 class="text-xl font-bold text-gray-900 pr-10" id="roleModalTitle">Manage Roles</h3>
                            <p class="text-gray-600 mt-1">Select roles for this user</p>
                        </div>
                        <!-- Body -->
                        <div class="p-6">
                            <div class="space-y-3" id="roleCheckboxes">
                                <!-- Role checkboxes will be dynamically loaded here -->
                            </div>
                        </div>
                        <!-- Footer -->
                        <div class="px-6 py-4 bg-gray-50 rounded-b-2xl flex justify-end space-x-3">
                            <button onclick="closeRoleModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium transition-colors hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                                Cancel
                            </button>
                            <button onclick="saveUserRoles()" id="saveRolesBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium transition-colors hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                Save Roles
                            </button>
                        </div>
                    </div>
                </div>

                <!-- User Details Modal -->
                <div id="userDetailsModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 pt-20 z-50 hidden">
                    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] overflow-y-auto mt-4">
                        <!-- Header -->
                        <div class="relative bg-gradient-to-r from-slate-50 to-gray-50 p-6 rounded-t-2xl border-b border-gray-100">
                            <button onclick="closeUserModal()" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 transition-colors text-gray-500 hover:text-gray-700">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                            <h2 class="text-2xl font-bold text-gray-900 pr-10">User Profile</h2>
                            <p class="text-gray-600 mt-1">Complete user information and details</p>
                        </div>
                        <div class="p-6">
                            <!-- Profile Image Section -->
                            <div class="flex flex-col items-center mb-8">
                                <div class="relative mb-4">
                                    <div class="w-32 h-32 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-3xl font-bold text-white shadow-lg ring-4 ring-gray-100">
                                        <span id="userProfileInitials">U</span>
                                    </div>
                                    <div class="absolute -bottom-1 -right-1 w-8 h-8 bg-white rounded-full flex items-center justify-center shadow-md">
                                        <div class="w-4 h-4 rounded-full bg-green-400" id="userStatusIndicator"></div>
                                    </div>
                                </div>
                                <h3 class="text-xl font-semibold text-gray-900" id="userProfileName">User Name</h3>
                                <p class="text-gray-600" id="userProfileEmail">user@email.com</p>
                            </div>
                            <!-- Details Grid -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Basic Information -->
                                <div class="space-y-4">
                                    <h4 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-2">Basic Information</h4>
                                    <div class="space-y-3">
                                        <div class="flex items-start">
                                            <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center mr-3 mt-0.5">
                                                <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                                </svg>
                                            </div>
                                            <div>
                                                <p class="text-sm font-medium text-gray-700">Full Name</p>
                                                <p class="text-gray-900" id="userDetailName">-</p>
                                            </div>
                                        </div>
                                        <div class="flex items-start">
                                            <div class="w-8 h-8 rounded-lg bg-green-100 flex items-center justify-center mr-3 mt-0.5">
                                                <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                                </svg>
                                            </div>
                                            <div>
                                                <p class="text-sm font-medium text-gray-700">Email Address</p>
                                                <p class="text-gray-900 break-all" id="userDetailEmail">-</p>
                                            </div>
                                        </div>
                                        <div class="flex items-start">
                                            <div class="w-8 h-8 rounded-lg bg-purple-100 flex items-center justify-center mr-3 mt-0.5">
                                                <svg class="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                                </svg>
                                            </div>
                                            <div>
                                                <p class="text-sm font-medium text-gray-700">User ID</p>
                                                <p class="text-gray-900 font-mono text-sm" id="userDetailId">-</p>
                                            </div>
                                        </div>
                                        <div class="flex items-start">
                                            <div class="w-8 h-8 rounded-lg bg-indigo-100 flex items-center justify-center mr-3 mt-0.5">
                                                <svg class="w-4 h-4 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                                </svg>
                                            </div>
                                            <div>
                                                <p class="text-sm font-medium text-gray-700">Phone Number</p>
                                                <p class="text-gray-900" id="userDetailPhone">-</p>
                                            </div>
                                        </div>
                                        <div class="flex items-start">
                                            <div class="w-8 h-8 rounded-lg bg-cyan-100 flex items-center justify-center mr-3 mt-0.5">
                                                <svg class="w-4 h-4 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"></path>
                                                </svg>
                                            </div>
                                            <div>
                                                <p class="text-sm font-medium text-gray-700">Username</p>
                                                <p class="text-gray-900" id="userDetailUsername">-</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Status & Roles -->
                                <div class="space-y-4">
                                    <h4 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-2">Status & Permissions</h4>
                                    <div class="space-y-4">
                                        <!-- Account Status -->
                                        <div>
                                            <p class="text-sm font-medium text-gray-700 mb-2">Account Status</p>
                                            <div id="userDetailStatus">
                                                <!-- Status badge will be inserted here -->
                                            </div>
                                        </div>
                                        <!-- User Roles -->
                                        <div>
                                            <p class="text-sm font-medium text-gray-700 mb-3">Assigned Roles</p>
                                            <div id="userDetailRoles">
                                                <!-- Roles will be inserted here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Footer Actions -->
                            <div class="mt-8 pt-6 border-t border-gray-200 flex justify-end">
                                <button onclick="closeUserModal()" class="px-6 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-gray-300">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Roles Section -->
            <div id="rolesSection" class="content-section hidden">
                <!-- Page Header -->
                <div class="mb-8">
                    <div class="bg-white overflow-hidden shadow rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900">Role Management System</h2>
                                    <p class="mt-1 text-sm text-gray-600">Manage user roles and permissions across the system</p>
                                </div>
                                <button onclick="openAddRoleModal()" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors">
                                    <i class="fas fa-plus mr-2"></i>Add New Role
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Roles Table -->
                <div class="bg-white shadow overflow-hidden sm:rounded-md">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="mb-4">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-medium text-gray-900">System Roles</h3>
                                <div class="flex items-center space-x-2">
                                    <input type="text" id="roleSearch" placeholder="Search roles..."
                                           class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                           onkeyup="handleSearch()">
                                    <button onclick="loadRoles()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-md text-sm font-medium">
                                        <i class="fas fa-refresh mr-1"></i>Refresh
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Loading State -->
                        <div id="roleLoadingState" class="text-center py-8">
                            <div class="inline-flex items-center px-4 py-2 font-semibold leading-6 text-sm shadow rounded-md text-white bg-primary-500 hover:bg-primary-400 transition ease-in-out duration-150 cursor-not-allowed">
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Loading roles...
                            </div>
                        </div>

                        <!-- Roles Table -->
                        <div id="rolesTable" class="hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role ID</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role Name</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created Date</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rolesTableBody" class="bg-white divide-y divide-gray-200">
                                        <!-- Roles will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div id="roleEmptyState" class="text-center py-12 hidden">
                            <i class="fas fa-user-shield text-4xl text-gray-400 mb-4"></i>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No roles found</h3>
                            <p class="text-gray-600 mb-4">Get started by creating your first role.</p>
                            <button onclick="openAddRoleModal()" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                                <i class="fas fa-plus mr-2"></i>Add Role
                            </button>
                        </div>
                    </div>
                </div>
            </div>

                <!-- Add Role Modal -->
                <div id="addRoleModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg font-medium text-gray-900">Add New Role</h3>
                                <button onclick="closeAddRoleModal()" class="text-gray-400 hover:text-gray-600">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <form id="addRoleForm" onsubmit="handleAddRole(event)">
                            <div class="p-6 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Role Name *</label>
                                    <input type="text" name="roleName" required
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                           placeholder="e.g., ROLE_STUDENT">
                                    <p class="text-xs text-gray-500 mt-1">Use ROLE_ prefix for consistency</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                    <textarea name="description" rows="3"
                                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                              placeholder="Describe the role's purpose and permissions"></textarea>
                                </div>
                            </div>
                            <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                                <button type="button" onclick="closeAddRoleModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700">
                                    Add Role
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Delete Role Modal -->
                <div id="deleteRoleModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-medium text-gray-900">Confirm Role Deletion</h3>
                        </div>
                        <div class="p-6">
                            <div class="flex items-center mb-4">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-triangle text-2xl text-red-600"></i>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-gray-900">Are you sure?</h3>
                                    <div class="mt-2 text-sm text-gray-500">
                                        <p>This will permanently delete the role <strong id="roleToDelete"></strong>.</p>
                                        <p class="mt-1">This action cannot be undone and may affect users assigned to this role.</p>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end space-x-3">
                                <button onclick="closeDeleteRoleModal()" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                                    Cancel
                                </button>
                                <button onclick="confirmDeleteRole()" class="px-4 py-2 bg-red-600 text-white rounded-md text-sm font-medium hover:bg-red-700">
                                    <i class="fas fa-trash mr-2"></i>Delete Role
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // User Management Variables
        let activeTab = 0;
        let searchTerm = '';
        let currentPage = 1;
        let pageSize = 10;
        let totalPages = 1;
        let totalUsers = 0;
        let loading = false;
        let error = null;
        let users = [];
        let currentEditingUser = null;

        // Toggle sidebar for mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const mainContent = document.getElementById('mainContent');

            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                overlay.classList.add('hidden');
            } else {
                sidebar.classList.add('open');
                overlay.classList.remove('hidden');
            }
        }

        // Show different sections
        function showSection(section) {
            console.log('🎯 showSection called with:', section);

            // Hide all sections
            const allSections = document.querySelectorAll('.content-section');
            console.log('🎯 Found sections:', allSections.length);
            allSections.forEach(el => {
                console.log('🎯 Hiding section:', el.id, 'classes:', el.className);
                el.classList.add('hidden');
                el.style.display = 'none'; // Force hide
            });

            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active', 'bg-primary-100', 'text-primary-700');
                el.classList.add('text-gray-600');
            });

            // Show selected section
            if (section === 'overview') {
                const overviewSection = document.getElementById('overviewSection');
                console.log('🎯 Showing overview section:', !!overviewSection);
                overviewSection.classList.remove('hidden');
                overviewSection.style.display = 'block'; // Force show
                document.getElementById('pageTitle').textContent = 'Dashboard Overview';
                document.getElementById('pageSubtitle').textContent = 'System-wide analytics and management';
                document.querySelector('[data-section="overview"]').classList.add('active');
            } else if (section === 'users') {
                const usersSection = document.getElementById('usersSection');
                console.log('🎯 Showing users section:', !!usersSection);
                usersSection.classList.remove('hidden');
                usersSection.style.display = 'block'; // Force show
                document.getElementById('pageTitle').textContent = 'User Management';
                document.getElementById('pageSubtitle').textContent = 'Manage all system users';
                document.querySelector('[data-section="users"]').classList.add('active');
                // Load users when section is shown
                setTimeout(() => {
                    loadUsers();
                    setupEventListeners();
                }, 100);
            } else if (section === 'roles') {
                const rolesSection = document.getElementById('rolesSection');
                console.log('🎯 Showing roles section:', !!rolesSection);
                console.log('🎯 Roles section classes before:', rolesSection.className);
                rolesSection.classList.remove('hidden');
                rolesSection.style.display = 'block'; // Force show
                console.log('🎯 Roles section classes after:', rolesSection.className);
                console.log('🎯 Roles section style.display:', rolesSection.style.display);
                document.getElementById('pageTitle').textContent = 'Role Management';
                document.getElementById('pageSubtitle').textContent = 'Configure user roles and permissions';
                document.querySelector('[data-section="roles"]').classList.add('active');
                // Load roles when section is shown
                setTimeout(() => {
                    loadRoles();
                }, 100);
            }

            // Close sidebar on mobile after selection
            if (window.innerWidth < 768) {
                toggleSidebar();
            }
        }

        // Load user info
        function loadUserInfo() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (user.name) {
                document.getElementById('userName').textContent = user.name;
            }
        }

        // Logout function
        function logout() {
            localStorage.removeItem('jwtToken');
            localStorage.removeItem('token');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }

        // Load stats on page load
        async function loadStats() {
            try {
                const token = localStorage.getItem('jwtToken') || localStorage.getItem('token');

                // Load users count
                const usersResponse = await fetch('/api/users/filter?pageNumber=0&pageSize=1', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const usersData = await usersResponse.json();
                if (usersData.responseStatus === 'OK') {
                    document.getElementById('totalUsersCount').textContent = usersData.data.payload?.totalElements || 0;
                }

                // Load roles count
                const rolesResponse = await fetch('/api/roles', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const rolesData = await rolesResponse.json();
                if (rolesData.responseStatus === 'OK') {
                    document.getElementById('totalRolesCount').textContent = rolesData.data?.length || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search input
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    searchTerm = e.target.value;
                    currentPage = 1;
                    loadUsers();
                });
            }

            // Page size selector
            const pageSizeSelect = document.getElementById('pageSizeSelect');
            if (pageSizeSelect) {
                pageSizeSelect.addEventListener('change', function(e) {
                    pageSize = parseInt(e.target.value);
                    currentPage = 1;
                    loadUsers();
                });
            }
        }

        // Load all users
        async function loadUsers() {
            try {
                loading = true;
                showLoading();

                const token = localStorage.getItem('jwtToken') || localStorage.getItem('token');

                if (!token) {
                    alert('⚠️ Please login first');
                    window.location.href = '/login';
                    return;
                }

                const params = new URLSearchParams({
                    pageNumber: currentPage - 1,
                    pageSize: pageSize,
                    sortBy: 'name',
                    sortDir: 'asc'
                });

                // Add filters based on active tab - exactly from backup
                switch (activeTab) {
                    case 1: // Active
                        params.append('isDeleted', 'false');
                        params.append('isActive', 'true');
                        break;
                    case 2: // Deleted
                        params.append('isDeleted', 'true');
                        break;
                    case 3: // Expired
                        params.append('isDeleted', 'false');
                        params.append('isActive', 'false');
                        break;
                    default: // All Users
                        params.append('isDeleted', 'false');
                        break;
                }

                if (searchTerm) {
                    params.append('keyword', searchTerm);
                }

                const url = `/api/users/filter?${params.toString()}`;
                console.log('Fetching users with params:', params.toString());

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401 || response.status === 403) {
                    alert('⚠️ Session expired! Please login again.');
                    localStorage.removeItem('jwtToken');
                    localStorage.removeItem('token');
                    localStorage.removeItem('refreshToken');
                    localStorage.removeItem('user');
                    window.location.href = '/login';
                    return;
                }

                const result = await response.json();
                console.log('API Response:', result);
                console.log('result.data:', result.data);
                console.log('result.data type:', typeof result.data);
                console.log('result.data keys:', result.data ? Object.keys(result.data) : 'no data');

                if (response.ok && result.responseStatus === 'OK') {
                    // Handle different response structures
                    let usersData = [];
                    let totalCount = 0;
                    let totalPagesCount = 1;

                    if (result.data && result.data.payload && result.data.payload.content) {
                        // Original expected structure
                        usersData = result.data.payload.content;
                        totalCount = result.data.payload.totalElements;
                        totalPagesCount = result.data.payload.totalPages;
                    } else if (result.data && result.data.content) {
                        // Alternative structure
                        usersData = result.data.content;
                        totalCount = result.data.totalElements;
                        totalPagesCount = result.data.totalPages;
                    } else if (result.data && Array.isArray(result.data)) {
                        // Direct array
                        usersData = result.data;
                        totalCount = result.data.length;
                        totalPagesCount = 1;
                    } else if (Array.isArray(result.data)) {
                        // Direct array at root
                        usersData = result.data;
                        totalCount = result.data.length;
                        totalPagesCount = 1;
                    } else {
                        console.error('Unknown response structure:', result);
                        console.error('Trying to use result.data as is...');
                        // Try to use result.data as single page response
                        usersData = result.data ? [result.data] : [];
                        totalCount = usersData.length;
                        totalPagesCount = 1;
                    }

                    console.log('Parsed users:', usersData);
                    console.log('Total users:', totalCount);

                    // Debug first user structure
                    if (usersData && usersData.length > 0) {
                        console.log('First user:', usersData[0]);
                        console.log('First user roles:', usersData[0].roles);
                        if (usersData[0].roles && usersData[0].roles.length > 0) {
                            console.log('First role:', usersData[0].roles[0]);
                        }
                    }

                    users = usersData;
                    totalUsers = totalCount;
                    totalPages = totalPagesCount;

                    displayUsers(users);
                    updatePagination();
                } else {
                    showError('Failed to load users: ' + (result.message || 'Unknown error'));
                }

            } catch (error) {
                console.error('Error loading users:', error);
                showError('Failed to load users. Please try again.');
            } finally {
                loading = false;
                hideLoading();
            }
        }

        // Display users in table
        function displayUsers(usersToDisplay) {
            const tableBody = document.getElementById('usersTable');

            if (!tableBody) return;

            if (usersToDisplay.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                            <i class="fas fa-users text-4xl mb-4 block"></i>
                            No users found
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = usersToDisplay.map(user => {
                const initials = user.name ? user.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) : 'U';
                const status = user.accountStatus?.isActive ? 'Active' : 'Inactive';
                const statusColor = user.accountStatus?.isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';

                // Better role display with badges
                let rolesHTML = '';
                if (user.roles && Array.isArray(user.roles) && user.roles.length > 0) {
                    rolesHTML = user.roles.map(role => {
                        // Role structure: Role(id=3, name=NORMAL, isActive=true, isDeleted=false)
                        // Use the working implementation from backup file
                        const roleName = role.name || role.toString().match(/name=([^,)]+)/)?.[1] || role.toString();
                        const displayName = roleName.replace('ROLE_', '');

                        const roleColors = {
                            'OWNER': 'bg-purple-100 text-purple-800',
                            'STUDENT': 'bg-blue-100 text-blue-800',
                            'TEACHER': 'bg-green-100 text-green-800',
                            'PARENT': 'bg-pink-100 text-pink-800',
                            'ADMIN': 'bg-red-100 text-red-800',
                            'SUPER_ADMIN': 'bg-gray-100 text-gray-800',
                            'NORMAL': 'bg-gray-100 text-gray-600'
                        };
                        const colorClass = roleColors[displayName] || 'bg-gray-100 text-gray-600';
                        return `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${colorClass} mr-1 mb-1">${displayName}</span>`;
                    }).join('');
                } else {
                    rolesHTML = '<span class="text-gray-400 text-xs">No roles</span>';
                }

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-medium text-sm">
                                    ${initials}
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${user.name || 'Unknown'}</div>
                                    <div class="text-sm text-gray-500">${user.username || 'N/A'}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-900">${user.email || 'N/A'}</div>
                            <div class="text-sm text-gray-500">${user.phoNo || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
                                ${status}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex flex-wrap">
                                ${rolesHTML}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex gap-1">
                                ${getTabSpecificActions(user)}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Get tab-specific actions - exactly from backup
        function getTabSpecificActions(user) {
            let actions = '';

            // Edit Roles Button - show for All Users and Active tabs
            if (activeTab === 0 || activeTab === 1) {
                actions += `
                    <button
                        onclick="editUser(${user.id})"
                        class="inline-flex items-center justify-center w-8 h-6 border border-transparent text-xs font-medium rounded text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-1 focus:ring-blue-500"
                        title="Manage Roles"
                    >
                        ✏️
                    </button>
                `;
            }

            // Tab-specific actions
            if (activeTab === 0) {
                // All Users tab
                actions += `
                    <button
                        onclick="toggleUserStatus(${user.id}, ${user.accountStatus?.isActive === true})"
                        class="inline-flex items-center justify-center w-8 h-6 border border-transparent text-xs font-medium rounded focus:outline-none focus:ring-1 ${user.accountStatus?.isActive === true ? 'text-orange-700 bg-orange-100 hover:bg-orange-200 focus:ring-orange-500' : 'text-green-700 bg-green-100 hover:bg-green-200 focus:ring-green-500'}"
                        title="${user.accountStatus?.isActive === true ? 'Deactivate User' : 'Activate User'}"
                    >
                        ${user.accountStatus?.isActive === true ? '⏸️' : '▶️'}
                    </button>
                    <button
                        onclick="deleteUser(${user.id})"
                        class="inline-flex items-center justify-center w-8 h-6 border border-transparent text-xs font-medium rounded text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-1 focus:ring-red-500"
                        title="Delete User"
                    >
                        🗑️
                    </button>
                `;
            } else if (activeTab === 1) {
                // Active tab
                actions += `
                    <button
                        onclick="viewUser(${user.id})"
                        class="inline-flex items-center justify-center w-8 h-6 border border-transparent text-xs font-medium rounded text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-1 focus:ring-indigo-500"
                        title="View User Details"
                    >
                        👁️
                    </button>
                    <button
                        onclick="deleteUser(${user.id})"
                        class="inline-flex items-center justify-center w-8 h-6 border border-transparent text-xs font-medium rounded text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-1 focus:ring-red-500"
                        title="Delete User"
                    >
                        🗑️
                    </button>
                `;
            } else if (activeTab === 2) {
                // Deleted tab
                actions += `
                    <button
                        onclick="handleRestore(${user.id})"
                        class="inline-flex items-center px-3 py-1 border border-transparent text-xs font-medium rounded-md text-green-700 bg-green-100 hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                    >
                        ↻ Restore
                    </button>
                    <button
                        onclick="handlePermanentDelete(${user.id})"
                        class="inline-flex items-center px-3 py-1 border border-transparent text-xs font-medium rounded-md text-red-700 bg-red-100 hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                    >
                        ❌ Permanent
                    </button>
                `;
            } else if (activeTab === 3) {
                // Expired tab
                actions += `
                    <button
                        onclick="toggleUserStatus(${user.id}, ${user.accountStatus?.isActive === true})"
                        class="inline-flex items-center px-3 py-1 border border-transparent text-xs font-medium rounded-md text-green-700 bg-green-100 hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                    >
                        ▶️ Activate
                    </button>
                `;
            }

            return actions;
        }

        // Handle tab changes
        function handleTabChange(tabIndex) {
            activeTab = tabIndex;
            currentPage = 1;

            // Update tab styles
            document.querySelectorAll('[role="tab"]').forEach((tab, index) => {
                if (index === tabIndex) {
                    tab.className = 'flex items-center gap-2 px-3 sm:px-4 py-3 border-b-2 font-medium text-sm transition-colors whitespace-nowrap border-blue-500 text-blue-600';
                } else {
                    tab.className = 'flex items-center gap-2 px-3 sm:px-4 py-3 border-b-2 font-medium text-sm transition-colors whitespace-nowrap border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
                }
            });

            loadUsers();
        }

        // Toggle user status - exactly from backup
        async function toggleUserStatus(userId, currentStatus) {
            try {
                const token = localStorage.getItem('jwtToken') || localStorage.getItem('token');
                const newStatus = !currentStatus;

                console.log('Toggling user status:', userId, 'from', currentStatus, 'to', newStatus);

                // Try different API endpoints that might work
                let response;

                // Use the correct endpoint format from React project
                const statusParams = new URLSearchParams({ isActive: newStatus });
                response = await fetch(`/api/users/${userId}/status?${statusParams}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    console.log('Status update failed, trying alternative endpoint');
                    // Try alternative endpoint with body
                    response = await fetch(`/api/users/${userId}/status`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            isActive: newStatus
                        })
                    });
                }

                if (response.ok) {
                    alert(`✅ User ${newStatus ? 'activated' : 'deactivated'} successfully!`);
                    loadUsers(); // Refresh the list
                } else {
                    const error = await response.json();
                    alert('❌ Error: ' + (error.message || 'Failed to update user status'));
                }
            } catch (error) {
                console.error('Error toggling user status:', error);
                alert('❌ Failed to update user status. Please try again.');
            }
        }

        // Edit user (open role modal)
        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                currentEditingUser = user;
                openRoleModal();
            }
        }

        // View user (open details modal)
        function viewUser(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                showUserDetailsModal(user);
            }
        }

        // Delete user (soft delete)
        async function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                try {
                    const token = localStorage.getItem('jwtToken') || localStorage.getItem('token');

                    const response = await fetch(`/api/users/${userId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        alert('✅ User deleted successfully!');
                        loadUsers(); // Refresh the list
                    } else {
                        const error = await response.json();
                        alert('❌ Error: ' + (error.message || 'Failed to delete user'));
                    }
                } catch (error) {
                    console.error('Error deleting user:', error);
                    alert('❌ Failed to delete user. Please try again.');
                }
            }
        }

        // Handle restore - exactly from backup
        async function handleRestore(userId) {
            try {
                const token = localStorage.getItem('jwtToken') || localStorage.getItem('token');
                if (!token) {
                    throw new Error('No JWT token found');
                }

                console.log('Restoring user:', userId);

                const response = await fetch(`/api/users/${userId}/restore`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Restore response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Restore error response:', errorText);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }

                console.log('Restore successful');
                alert('✅ User restored successfully!');

                // Refresh current view
                console.log('Refreshing user list after restore...');
                loadUsers();

            } catch (error) {
                console.error('Restore failed:', error);
                alert(`❌ Restore failed: ${error.message}`);
            }
        }

        // Handle permanent delete - exactly from backup
        async function handlePermanentDelete(userId) {
            console.log('❌ PERMANENT DELETE ATTEMPT for user ID:', userId);

            if (!confirm('⚠️ WARNING: This will permanently delete the user and ALL associated data!\n\nThis includes:\n• User profile\n• All relationships\n• All associated records\n\nThis action CANNOT be undone!\n\nAre you absolutely sure?')) {
                console.log('❌ User cancelled permanent delete');
                return;
            }

            try {
                const token = localStorage.getItem('jwtToken') || localStorage.getItem('token');
                if (!token) {
                    throw new Error('No JWT token found');
                }

                console.log('Permanently deleting user:', userId);

                const response = await fetch(`/api/users/${userId}/permanent`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Hard delete response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Hard delete error response:', errorText);

                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = JSON.parse(errorText);
                        if (errorData.errorMessage) {
                            errorMessage = errorData.errorMessage;
                        }
                        if (errorData.details) {
                            errorMessage += `\nDetails: ${errorData.details}`;
                        }
                    } catch (e) {
                        errorMessage += ` - ${errorText}`;
                    }

                    // Special handling for data integrity violation
                    if (errorMessage.includes('Data integrity violation')) {
                        errorMessage = '⚠️ Cannot permanently delete this user!\n\n' +
                                     'This user has associated data that prevents deletion:\n' +
                                     '• Students/Teachers (Workers)\n' +
                                     '• School classes they own\n' +
                                     '• Exams, assignments, or other records\n' +
                                     '• Library books they issued\n\n' +
                                     'Please use "Soft Delete" instead, which will:\n' +
                                     '• Mark the user as deleted\n' +
                                     '• Preserve all relationships\n' +
                                     '• Allow restoration if needed';
                    }

                    throw new Error(errorMessage);
                }

                console.log('Hard delete successful');
                alert('✅ User permanently deleted successfully!');

                // Refresh current view
                loadUsers();

            } catch (error) {
                console.error('Permanent delete failed:', error);
                alert(`❌ Permanent delete failed: ${error.message}`);
            }
        }

        // Open role modal
        function openRoleModal() {
            if (!currentEditingUser) return;

            document.getElementById('roleModalTitle').textContent = `Manage Roles - ${currentEditingUser.name}`;
            loadAvailableRoles();
            document.getElementById('roleEditorModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // Close role modal
        function closeRoleModal() {
            document.getElementById('roleEditorModal').classList.add('hidden');
            currentEditingUser = null;
            document.body.style.overflow = 'auto';
        }

        // Load available roles
        async function loadAvailableRoles() {
            try {
                const token = localStorage.getItem('jwtToken') || localStorage.getItem('token');
                const response = await fetch('/api/roles', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();
                if (result.responseStatus === 'OK') {
                    displayRoleCheckboxes(result.data);
                }
            } catch (error) {
                console.error('Error loading roles:', error);
            }
        }

        // Display role checkboxes
        function displayRoleCheckboxes(roles) {
            const container = document.getElementById('roleCheckboxes');

            // Get user's current role IDs - handle different role structures
            let userRoleIds = [];
            if (currentEditingUser.roles && Array.isArray(currentEditingUser.roles)) {
                userRoleIds = currentEditingUser.roles.map(r => {
                    if (typeof r === 'object' && r.id) {
                        return r.id;
                    } else if (typeof r === 'number') {
                        return r;
                    }
                    return null;
                }).filter(id => id !== null);
            }

            container.innerHTML = roles.map(role => {
                const roleName = role.name ? role.name.replace('ROLE_', '') : 'Unknown Role';
                const isChecked = userRoleIds.includes(role.id);

                return `
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox"
                               value="${role.name || 'UNKNOWN'}"
                               data-role-id="${role.id}"
                               ${isChecked ? 'checked' : ''}
                               class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                        <span class="text-sm font-medium text-gray-700">${roleName}</span>
                    </label>
                `;
            }).join('');
        }

        // Save user roles
        async function saveUserRoles() {
            try {
                const checkboxes = document.querySelectorAll('#roleCheckboxes input[type="checkbox"]:checked');
                const selectedRoleIds = Array.from(checkboxes).map(cb => parseInt(cb.getAttribute('data-role-id')));

                const token = localStorage.getItem('jwtToken') || localStorage.getItem('token');

                console.log('Saving roles for user:', currentEditingUser.id);
                console.log('Selected role IDs:', selectedRoleIds);

                const response = await fetch('/api/roles/replace', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: currentEditingUser.id,
                        roleIds: selectedRoleIds,
                        action: 'REPLACE'
                    })
                });

                if (response.ok) {
                    alert('✅ User roles updated successfully!');
                    closeRoleModal();
                    loadUsers(); // Refresh the list
                } else {
                    const error = await response.json();
                    alert('❌ Error: ' + (error.message || error.data || 'Failed to update user roles'));
                }
            } catch (error) {
                console.error('Error saving user roles:', error);
                alert('❌ Failed to update user roles. Please try again.');
            }
        }

        // Show User Details Modal (read-only) - matching React implementation exactly
        function showUserDetailsModal(user) {
            const modal = document.getElementById('userDetailsModal');

            // Set user details
            document.getElementById('userProfileName').textContent = user.name || 'Unknown User';
            document.getElementById('userProfileEmail').textContent = user.email || 'No email provided';
            document.getElementById('userDetailName').textContent = user.name || '-';
            document.getElementById('userDetailEmail').textContent = user.email || '-';
            document.getElementById('userDetailPhone').textContent = user.phoNo || '-';
            document.getElementById('userDetailUsername').textContent = user.username || '-';
            document.getElementById('userDetailId').textContent = user.id;

            // Set profile image initials
            const initials = (user.name || 'User').split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            document.getElementById('userProfileInitials').textContent = initials;

            // Set status - using === true to match React logic
            const isActive = user.accountStatus?.isActive === true;
            const statusElement = document.getElementById('userDetailStatus');
            const indicatorElement = document.getElementById('userStatusIndicator');

            if (isActive) {
                statusElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium border bg-emerald-50 text-emerald-700 border-emerald-200';
                statusElement.innerHTML = '<div class="w-2 h-2 rounded-full mr-2 bg-emerald-400"></div>Active';
                indicatorElement.className = 'w-4 h-4 rounded-full bg-green-400';
            } else {
                statusElement.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm font-medium border bg-rose-50 text-rose-700 border-rose-200';
                statusElement.innerHTML = '<div class="w-2 h-2 rounded-full mr-2 bg-rose-400"></div>Inactive';
                indicatorElement.className = 'w-4 h-4 rounded-full bg-red-400';
            }

            // Set roles - matching React implementation exactly
            const rolesContainer = document.getElementById('userDetailRoles');
            if (user.roles && user.roles.length > 0) {
                const roleColors = [
                    'bg-blue-50 text-blue-700 border-blue-200',
                    'bg-purple-50 text-purple-700 border-purple-200',
                    'bg-indigo-50 text-indigo-700 border-indigo-200',
                    'bg-cyan-50 text-cyan-700 border-cyan-200'
                ];

                rolesContainer.innerHTML = user.roles.map((role, index) => {
                    // Handle both object format and string format
                    let roleName;
                    if (typeof role === 'object' && role.name) {
                        roleName = role.name;
                    } else if (typeof role === 'string') {
                        roleName = role.match(/name=([^,)]+)/)?.[1] || role;
                    } else {
                        roleName = role.toString();
                    }

                    const displayName = roleName.replace('ROLE_', '');
                    const colorClass = roleColors[index % roleColors.length];

                    return `
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium border ${colorClass}">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                            ${displayName}
                        </span>
                    `;
                }).join('');
            } else {
                rolesContainer.innerHTML = `
                    <div class="flex items-center p-3 rounded-lg bg-gray-50 border border-gray-200">
                        <svg class="w-5 h-5 text-gray-400 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        <span class="text-gray-600 text-sm">No roles assigned</span>
                    </div>
                `;
            }

            // Show modal
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // Close user modal
        function closeUserModal() {
            document.getElementById('userDetailsModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // Pagination functions
        function changePage(direction) {
            if (direction === 'prev' && currentPage > 1) {
                currentPage--;
                loadUsers();
            } else if (direction === 'next' && currentPage < totalPages) {
                currentPage++;
                loadUsers();
            }
        }

        function updatePagination() {
            document.getElementById('showingStart').textContent =
                totalUsers === 0 ? 0 : ((currentPage - 1) * pageSize) + 1;
            document.getElementById('showingEnd').textContent =
                Math.min(currentPage * pageSize, totalUsers);
            document.getElementById('totalUsers').textContent = totalUsers;

            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
        }

        // Utility functions
        function showLoading() {
            const loadingState = document.getElementById('loadingState');
            const usersTableContainer = document.getElementById('usersTableContainer');
            if (loadingState) loadingState.classList.remove('hidden');
            if (usersTableContainer) usersTableContainer.classList.add('hidden');
        }

        function hideLoading() {
            const loadingState = document.getElementById('loadingState');
            const usersTableContainer = document.getElementById('usersTableContainer');
            if (loadingState) loadingState.classList.add('hidden');
            if (usersTableContainer) usersTableContainer.classList.remove('hidden');
        }

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            const errorState = document.getElementById('errorState');
            if (errorMessage) errorMessage.textContent = message;
            if (errorState) {
                errorState.classList.remove('hidden');
                setTimeout(() => {
                    errorState.classList.add('hidden');
                }, 5000);
            }
        }

        // Role Management Variables
        let roles = [];
        let roleToDelete = null;

        // Role Management Functions
        async function loadRoles() {
            try {
                const token = localStorage.getItem('jwtToken') || localStorage.getItem('token');

                if (!token) {
                    alert('⚠️ Please login first');
                    window.location.href = '/login';
                    return;
                }

                console.log('📋 Loading roles...');

                const response = await fetch('/api/roles', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('📡 Response status:', response.status);

                if (response.status === 401 || response.status === 403) {
                    alert('⚠️ Session expired! Please login again.');
                    localStorage.removeItem('jwtToken');
                    localStorage.removeItem('token');
                    localStorage.removeItem('refreshToken');
                    localStorage.removeItem('user');
                    window.location.href = '/login';
                    return;
                }

                const result = await response.json();
                console.log('📦 API Response:', result);

                if (response.ok && result.responseStatus === 'OK') {
                    roles = result.data || [];
                    console.log('🎯 About to call displayRoles with:', roles.length, 'roles');
                    displayRoles(roles);
                    console.log('🎯 displayRoles called successfully');
                } else {
                    console.error('❌ Error loading roles:', result);
                    alert('❌ Failed to load roles: ' + (result.message || 'Unknown error'));
                }

            } catch (error) {
                console.error('❌ Error loading roles:', error);
                alert('❌ Failed to load roles. Please try again.');
            }
        }

        function displayRoles(rolesToDisplay) {
            console.log('🎯 displayRoles called with:', rolesToDisplay.length, 'roles');

            const loadingState = document.getElementById('roleLoadingState');
            const rolesTable = document.getElementById('rolesTable');
            const emptyState = document.getElementById('roleEmptyState');
            const tableBody = document.getElementById('rolesTableBody');

            console.log('🎯 Elements found:', {
                loadingState: !!loadingState,
                rolesTable: !!rolesTable,
                emptyState: !!emptyState,
                tableBody: !!tableBody
            });
            
            // Check which section these elements belong to
            console.log('🎯 loadingState parent section:', loadingState ? loadingState.closest('.content-section')?.id : 'N/A');
            console.log('🎯 rolesTable parent section:', rolesTable ? rolesTable.closest('.content-section')?.id : 'N/A');

            if (!loadingState || !rolesTable || !emptyState || !tableBody) {
                console.error('❌ Required elements not found');
                return;
            }

            // CRITICAL: Check if rolesTable has a parent wrapper that's hidden
            const rolesTableParent = rolesTable.parentElement;
            console.log('🎯 rolesTable parent element:', rolesTableParent?.tagName, rolesTableParent?.className);
            console.log('🎯 rolesTable parent display:', window.getComputedStyle(rolesTableParent).display);

            loadingState.classList.add('hidden');
            loadingState.style.display = 'none'; // Force hide with inline style
            console.log('🎯 Hidden loading state');

            if (rolesToDisplay.length === 0) {
                console.log('🎯 Showing empty state');
                emptyState.classList.remove('hidden');
                emptyState.style.display = 'block';
                rolesTable.classList.add('hidden');
                rolesTable.style.display = 'none';
                return;
            }

            console.log('🎯 Displaying', rolesToDisplay.length, 'roles');
            
            // Hide empty state
            emptyState.classList.add('hidden');
            emptyState.style.display = 'none';
            
            // Show roles table - FORCE visibility with aggressive CSS overrides
            rolesTable.classList.remove('hidden');
            rolesTable.style.display = 'block';
            rolesTable.style.visibility = 'visible';
            rolesTable.style.opacity = '1';
            rolesTable.style.position = 'relative';
            rolesTable.style.height = 'auto';
            rolesTable.style.width = '100%';
            rolesTable.style.background = 'white';
            rolesTable.style.border = '1px solid #e5e7eb';
            rolesTable.style.borderRadius = '0.375rem';
            rolesTable.style.overflow = 'visible';
            rolesTable.style.zIndex = '1';
            
            console.log('🎯 After showing table:');
            console.log('  - rolesTable.className:', rolesTable.className);
            console.log('  - rolesTable.style.display:', rolesTable.style.display);
            console.log('  - computed display:', window.getComputedStyle(rolesTable).display);
            console.log('  - computed visibility:', window.getComputedStyle(rolesTable).visibility);
            
            // DEBUGGING: Check if table content is actually there
            const table = rolesTable.querySelector('table');
            const tbody = rolesTable.querySelector('tbody');
            const rows = rolesTable.querySelectorAll('tr');
            console.log('🎯 DOM Debug:');
            console.log('  - Table element:', !!table);
            console.log('  - Tbody element:', !!tbody);
            console.log('  - Row count:', rows.length);
            console.log('  - Tbody innerHTML length:', tbody ? tbody.innerHTML.length : 'N/A');
            console.log('  - Table parent display:', window.getComputedStyle(table?.parentElement).display);
            
            // FORCE table to be visible by checking parent elements
            let parent = rolesTable.parentElement;
            while (parent && parent !== document.body) {
                const computedStyle = window.getComputedStyle(parent);
                console.log(`  - Parent ${parent.tagName} display:`, computedStyle.display);
                if (computedStyle.display === 'none') {
                    console.log('🚨 FOUND HIDDEN PARENT!', parent);
                    parent.style.display = 'block';
                }
                parent = parent.parentElement;
            }

            tableBody.innerHTML = rolesToDisplay.map(role => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${role.id}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            ${role.name}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${role.isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${role.isActive ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${new Date(role.createdOn || role.createdDate).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="deleteRole(${role.id}, '${role.name}')"
                                class="text-red-600 hover:text-red-900 mr-3">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                </tr>
            `).join('');
            
            console.log('🎯 Table populated:');
            console.log('  - innerHTML length:', tableBody.innerHTML.length);
            console.log('  - row count:', tableBody.children.length);
            
            // TEMPORARY: Add a visible test element to confirm table is there
            const testDiv = document.createElement('div');
            testDiv.style.cssText = 'position: fixed; top: 10px; right: 10px; background: red; color: white; padding: 10px; z-index: 9999; font-weight: bold;';
            testDiv.textContent = `✅ TABLE HAS ${tableBody.children.length} ROWS!`;
            document.body.appendChild(testDiv);
            
            // Remove test element after 3 seconds
            setTimeout(() => {
                if (testDiv.parentNode) {
                    testDiv.parentNode.removeChild(testDiv);
                }
            }, 3000);
            
            console.log('🎯 displayRoles completed');
        }

        function handleSearch() {
            const searchTerm = document.getElementById('roleSearch').value.toLowerCase();
            const filteredRoles = roles.filter(role =>
                role.name.toLowerCase().includes(searchTerm)
            );
            displayRoles(filteredRoles);
        }

        function openAddRoleModal() {
            document.getElementById('addRoleModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        function closeAddRoleModal() {
            document.getElementById('addRoleModal').classList.add('hidden');
            document.getElementById('addRoleForm').reset();
            document.body.style.overflow = 'auto';
        }

        // Handle add role form submission
        document.getElementById('addRoleForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(e.target);
            const roleName = formData.get('roleName').trim();
            const description = formData.get('description').trim();

            const token = localStorage.getItem('jwtToken') || localStorage.getItem('token');

            if (!token) {
                alert('⚠️ Please login first');
                window.location.href = '/login';
                return;
            }

            // Show loading
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Adding...';

            try {
                console.log('📝 Creating role:', roleName);

                const requestBody = {
                    name: roleName,
                    description: description || null
                };

                const response = await fetch('/api/roles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestBody)
                });

                console.log('📡 Response status:', response.status);
                const result = await response.json();
                console.log('📦 API Response:', result);

                if (response.status === 201 || response.status === 200) {
                    alert('✅ Role created successfully!');
                    closeAddRoleModal();
                    loadRoles(); // Refresh the list
                } else if (response.status === 401 || response.status === 403) {
                    alert('⚠️ Session expired! Please login again.');
                    localStorage.removeItem('jwtToken');
                    localStorage.removeItem('token');
                    localStorage.removeItem('refreshToken');
                    localStorage.removeItem('user');
                    window.location.href = '/login';
                } else {
                    alert('❌ Error: ' + (result.message || result.data || 'Failed to create role'));
                }

            } catch (error) {
                console.error('❌ Error creating role:', error);
                alert('❌ Failed to create role. Please try again.');
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Delete role
        function deleteRole(roleId, roleName) {
            roleToDelete = { id: roleId, name: roleName };
            document.getElementById('roleToDelete').textContent = roleName;
            document.getElementById('deleteRoleModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // Close delete role modal
        function closeDeleteRoleModal() {
            document.getElementById('deleteRoleModal').classList.add('hidden');
            roleToDelete = null;
            document.body.style.overflow = 'auto';
        }

        // Confirm delete role
        async function confirmDeleteRole() {
            if (!roleToDelete) return;

            const token = localStorage.getItem('jwtToken') || localStorage.getItem('token');

            if (!token) {
                alert('⚠️ Please login first');
                window.location.href = '/login';
                return;
            }

            try {
                console.log('🗑️ Deleting role:', roleToDelete.name);

                const response = await fetch(`/api/roles/${roleToDelete.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('📡 Response status:', response.status);
                const result = await response.json();
                console.log('📦 API Response:', result);

                if (response.ok) {
                    alert('✅ Role deleted successfully!');
                    closeDeleteRoleModal();
                    loadRoles(); // Refresh the list
                } else if (response.status === 401 || response.status === 403) {
                    alert('⚠️ Session expired! Please login again.');
                    localStorage.removeItem('jwtToken');
                    localStorage.removeItem('token');
                    localStorage.removeItem('refreshToken');
                    localStorage.removeItem('user');
                    window.location.href = '/login';
                } else {
                    alert('❌ Error: ' + (result.message || result.data || 'Failed to delete role'));
                }

            } catch (error) {
                console.error('❌ Error deleting role:', error);
                alert('❌ Failed to delete role. Please try again.');
            }
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const roleModal = document.getElementById('roleEditorModal');
            const userModal = document.getElementById('userDetailsModal');
            const addRoleModal = document.getElementById('addRoleModal');
            const deleteRoleModal = document.getElementById('deleteRoleModal');

            if (event.target === roleModal) {
                closeRoleModal();
            }
            if (event.target === userModal) {
                closeUserModal();
            }
            if (event.target === addRoleModal) {
                closeAddRoleModal();
            }
            if (event.target === deleteRoleModal) {
                closeDeleteRoleModal();
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            loadStats();
        });
    </script>
</body>
</html>